#### NTLM Authentication
##### Remote NTLM Authentication  
- Used when a user attempts to authenticate to a remote server  
How it works?  
- **Type 1 Message:** The client sends a packet to negotiate the terms of the authentication process. The packet optionally contains the name of the client machine and its domain. The server receives the packet and can check that authentication was started from a different machine.  
- **Type 2 Message:** The server responds to the client with a challenge. The "challenge" is a random number used to authenticate the client without having to pass their credentials through the network.  
- **Type 3 Message:** The client uses the challenge received on the Type 2 message and combines it with the user's password hash to generate a response to the challenge. The response is sent to the server as part of the Type 3 message. That way, the server can check if the client knows the correct user's password hash without transferring it through the network.  
##### Local NTLM Authentication  
- Used when a user tries to log into a service running on the same machine relying on a Security Context (A set of security parameters associated with a connection, including the session key and the user whose privileges).  
- **Type 1 Message:** The client sends this message to start the connection. It is used to negotiate authentication parameters just like before but also contains the name of the client machine and its domain. The server can check the client's name and domain, and the local authentication process begins if they match their own.  
- **Type 2 Message:** The server creates a Security Context and sends back its ID to the client in this message. The client can then use the Security Context ID to associate itself with the connection.  
- **Type 3 Message:** If the client successfully associates themselves with an existing Security Context ID, an empty Type 3 message is sent back to the server to signal that the local authentication process succeeded.

#### How Local Potato works?
[Local Potato](https://github.com/decoder-it/LocalPotato) takes advantage of a flaw in a special case of NTLM authentication called NTLM local authentication to trick a privileged process into authenticating a session that the attacker initiates against the local SMB server.

1. Attacker will trigger a privileged process 1 to connect to a rogue server.
2. The rogue server will instantiate a **Security Context A** for privileged process 1 but won't send it back immediately.
3. Attacker will launch a rogue client that simultaneously initiates a connection against the local SMB server with its unprivileged credentials.
4. The rogue client will send NTLM Type 1 message to initiate NTLM authentication and the server will reply with a Type 2 message with the ID for a **Security Context B**.
5. Attacker can swap the two Context IDs from both connections such that privileged process 1 will associate its user with **Security Context B**. 
6. Attacker's client can now access any network share with SYSTEM privilege
